<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="format-detection" content="telephone=no, email=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>LOGIC FLOW</title>
  <link rel="stylesheet" href="./src/style/index.css">
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      width: 100%;
      height: 100%;
    }

    body {
      background-color: #FFF;
      position: relative; 
    }

    #app {
      /* margin-top: 30px;
      margin-left: 30px; */
      width: 800px;
      height: 500px;
      /* width: 100%;
      height: 100%; */
      position: absolute;
      top: 0;
      left: 0;
      display: none;
    }

    *:focus {
      outline: none;
    }

    .rect {
      width: 50px;
      height: 50px;
      border: 2px solid #000;
      background: #fff;
    }

    .circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #000;
      background: #fff;
    }

    .uml-wrapper {
      background: rgb(255, 242, 204);
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: 1px solid rgb(214, 182, 86);
      box-sizing: border-box;
    }

    .uml-head {
      text-align: center;
      line-height: 30px;
      font-size: 16px;
      font-weight: bold;
    }

    .uml-body {
      border-top: 1px solid rgb(214, 182, 86);
      border-bottom: 1px solid rgb(214, 182, 86);
      padding: 5px 10px;
      font-size: 12px;
    }

    .uml-footer {
      padding: 5px 10px;
      font-size: 14px;
    }

    /* 输入框字体大小和设置的大小保持一致，自动换行输入和展示保持一致 */
    .lf-text-input {
      font-size: 12px;
    }
    .buttons {
      position: absolute;
      z-index: 1;
    }
    .button-list {
      display: flex;
      align-items: center;
    }
  </style>
</head>

<body>
  <div class="buttons">
    <div class="button-list">
      <button class="text" onClick="setArrow('half')">箭头1</button>
      <button class="text" onClick="setArrow('empty')">箭头2</button>
      <button onClick="focusOn()">定位到五角星</button>
      <button id="undo" onClick="undo()" disabled>上一步</button>
      <button id="redo" onClick="redo()" disabled>下一步</button>
      <button id="clearData" onClick="clearData()">清空数据</button>
      <button id="changeType" onClick="changeNodeType()">切换节点为五角星</button>
      <button id="changeConfig" onClick="changeEditConfig()">修改配置</button>
      <button id="changeConfig2" onClick="focusOut()">取消编辑</button>
      <button id="changeEdgeId" onClick="changeEdgeId()">修改边Id</button>
    </div>
    <div class="button-list">
      <button onClick="getData()">获取数据</button>
      <button onClick="getRefreshData()">属性流程图节点id</button>
      <button onClick="setProperties()">设置属性</button>
      <button onClick="setZoom()">设置大小</button>
      <button onClick="selectElement()">选中指定节点</button>
      <button onClick="triggerLine()">触发边</button>
      <button onClick="translateCenter()">居中</button>
      <button onClick="fitView()">适应屏幕</button>
      <button onClick="getNodeEdges()">获取节点所有的边</button>
      <button onClick="openEdgeAnimation()">启动边动画</button>
      <button onClick="closeEdgeAnimation()">关闭边动画</button>
      <button onClick="showCanvas()">显示流程图</button>
      <button onClick="deleteNode()">删除节点1</button>
    </div>
    <div class="button-list">
      <div class="rect" onmousedown="mouseDownRect()"></div>
      <div class="circle" onmousedown="mouseDownCircle()"></div>
      <div class="text" onmousedown="mouseDownText()">文本</div>
      <span>复制我</span>
    </div>
  </div>
  
  <div id="app"></div>
  <textarea id="data" style="width: 100px; height: 200px;float: right;"></textarea>
  <div id="debug"></div>
  <%= htmlWebpackPlugin.tags.bodyTags %>

    <script>
      window.onload = function () {
        InitLogicFlow();
        InitElementFunction();
        InitLogicFlowEvent();
        window.showCanvas()
      }
    </script>

    <!-- 自定义节点 -->
    <script>
      class UmlModel extends HtmlNodeModel {
        createId () {
          return Math.random() + '_uml'
        }
        setAttributes() {
          const width = 200;
          const height = 130;
          this.width = width;
          this.height = height;
          this.textHeight = 60;
          this.text = {
            ...this.text,
            y: this.y - this.height / 2
          }
          const properties = this.properties;
          this.anchorsOffset = [
            {
              x: width / 2,
              y: 0,
              isSourceAnchor: false,
              isTargetAnchor: true,
            }
          ]
          // this.anchorsOffset = [
          //   [width / 2, 0],
          //   [0, height / 2],
          //   [-width / 2, 0],
          //   [0, -height / 2],
          // ]
        }
      }
      class UmlNode extends HtmlNode {
        setHtml(rootEl) {
          const { properties } = this.props.model;
          const el = document.createElement('div');
          el.className = 'uml-wrapper';
          const html = `
            <div>
              <div class="uml-head">Head</div>
              <div class="uml-body">
                <div>+ ${properties.name}</div>
                <div>+ ${properties.body}</div>
              </div>
              <div class="uml-footer">
                <div>+ setHead(Head $head)</div>
                <div>+ setBody(Body $body)</div>
              </div>
            </div>
          `
          el.innerHTML = html;
          rootEl.innerHTML = '';
          rootEl.appendChild(el);
        }
      }
      // square
      class SquareModel extends RectNodeModel {
        setAttributes() {
          const size = 80;
          const circleOnlyAsTarget = {
            message: "正方形节点下一个节点只能是圆形节点",
            validate: (source, target) => {
              return target.type === "circle";
            },
          };

          this.width = size;
          this.height = size;
          this.anchorsOffset = [
            [size / 2, 0],
            [-size / 2, 0]
          ];
          this.sourceRules.push(circleOnlyAsTarget);
        }
      }
      class SquareView extends RectNode {
        getTextStyle() {
          const style = super.getTextStyle()
          const {
            model: {
              properties = {},
            },
          } = this.props;
          if (properties.isUsed) {
            style.color = 'red'
          }
          return style
        }
        // getShape 的返回值是一个通过 h 方法创建的 svg 元素
        getShape() {
          const { x, y, width, height } = this.props.model;
          const { fill, stroke, strokeWidth } = this.props.model.getNodeStyle();
          const attrs = {
            x: x - width / 2,
            y: y - height / 2,
            width,
            height,
            stroke,
            fill,
            strokeWidth
          }
          // 使用 h 方法创建一个矩形
          return h(
            "g", {}, [
            h(
              "rect", { ...attrs }
            ),
            h(
              'svg',
              {
                x: x - width / 2 + 5,
                y: y - height / 2 + 5,
                width: 25,
                height: 25,
                viewBox: "0 0 1274 1024",
              },
              h(
                'path',
                {
                  fill: stroke,
                  d:
                    "M655.807326 287.35973m-223.989415 0a218.879 218.879 0 1 0 447.978829 0 218.879 218.879 0 1 0-447.978829 0ZM1039.955839 895.482975c-0.490184-212.177424-172.287821-384.030443-384.148513-384.030443-211.862739 0-383.660376 171.85302-384.15056 384.030443L1039.955839 895.482975z",
                }
              )
            )
          ]
          );
        }
      }

      // star
      class StarModel extends PolygonNodeModel {
        setAttributes() {
          this.points = [
            [45, 0],
            [20, 90],
            [90, 30],
            [0, 30],
            [80, 90]
          ];
          this.fill = '#456789';
          this.stroke = '#456789';
        }
      }

      // user
      class UserNode extends RectNode {
        getAnchorStyle() {
          return {
            stroke: '#18905F',
            strokeWidth: 2,
          };
        }
        getTextStyle() {
          return {
            fontSize: 12,
            fill: '#FFFFFF',
            autoWrap: true,
            lineHeight: 1.5,
            background: {
              fill: '#FF00FF',
              wrapPadding: '10,10'
            }
          };
        }
      }
      class UserModel extends RectNodeModel {
        setAttributes() {
          const { size } = this.properties;
          this.width = size * 40;
          this.height = size * 40;
          this.textWidth = 150;
          this.stroke = '#18905F';
          this.fill = 'red';
          this.radius = 10;
          this.text.value = 'id:' + this.id;
        }
      }

      // combine
      class CombineNode extends BaseNode {
        getShape() {
          const { x, y } = this.props.model;
          const { fill } = this.props.model.getNodeStyle();
          return h(
            'g',
            {
              transform: `matrix(1 0 0 1 ${x - 25} ${y - 25})`,
            },
            h('path', {
              d: 'm  0,6.65 l  0,36.885245901639344 c  1.639344262295082,8.196721311475411 47.540983606557376,8.196721311475411  49.18032786885246,0 l  0,-36.885245901639344 c -1.639344262295082,-8.196721311475411 -47.540983606557376,-8.196721311475411 -49.18032786885246,0c  1.639344262295082,8.196721311475411 47.540983606557376,8.196721311475411  49.18032786885246,0 m  -49.18032786885246,5.737704918032787c  1.639344262295082,8.196721311475411 47.540983606557376,8.196721311475411 49.18032786885246,0m  -49.18032786885246,5.737704918032787c  1.639344262295082,8.196721311475411 47.540983606557376,8.196721311475411  49.18032786885246,0',
              fill: fill,
              strokeWidth: 2,
              stroke: 'red',
              fillOpacity: 0.95,
            })
          )
        }
      }
      class CombineModel extends BaseNodeModel {
        setAttributes() {
          this.width = 50;
          this.height = 60;
          this.fill = 'orange';
          this.anchorsOffset = [
            [0, -this.height / 2],
            [this.width / 2, 0],
            [0, this.height / 2],
            [-this.width / 2, 0]
          ];
          // console.log(JSON.stringify(this.anchorsOffset));
        }
      }

      // connection
      class Connection extends PolylineEdge {
        getAdjustPointShape(x, y, model, isDragging) {
          return h("g", {}, [
            h("image", {
              x: x - 9,
              y: y - 9,
              width: 18,
              height: 18,
              cursor: 'move',
              'href': 'data:image/svg+xml;base64,PCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj48c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIyMnB4IiBoZWlnaHQ9IjIycHgiIHZlcnNpb249IjEuMSI+PGNpcmNsZSBjeD0iMTEiIGN5PSIxMSIgcj0iNyIgc3Ryb2tlPSIjZmZmIiBmaWxsPSIjMjliNmYyIi8+PGNpcmNsZSBjeD0iMTEiIGN5PSIxMSIgcj0iMyIgc3Ryb2tlPSIjZmZmIiBmaWxsPSJ0cmFuc3BhcmVudCIvPjwvc3ZnPg=='
            }),
          ]);
        }
        getTextStyle() {
          return {
            background: {
              fill: 'white',
              height: 20,
              stroke: 'transparent',
              radius: 0,
            }
          };
        }
        handleHover (hovered, ev) {
          super.handleHover(hovered, ev);
        }
        getEndArrow() {
          const { model, graphModel } = this.props;
          const { id, properties: { arrowType } } = model;
          const { stroke, strokeWidth } = model.getArrowStyle();
          const pathAttr = {
            stroke,
            strokeWidth
          }
          // 空心箭头
          if (arrowType === 'empty') {
            return h('path', {
              ...pathAttr,
              fill: '#FFF',
              d: 'M -10 0  -20 -5 -30 0 -20 5 z'
            })
          } else if (arrowType === 'half') { // 半箭头
            return (
              h('path', {
                ...pathAttr,
                d: 'M 0 0 -10 5'
              })
            )
          }
          return h('path', {
            ...pathAttr,
            fill: stroke,
            d: 'M 0 0 -10 -5 -10 5 z'
          })
        }
      }
      class ConnectionModel extends PolylineEdgeModel {
        setAttributes() {
          this.textWidth = 200;
          const { properties } = this;
          if (properties.isActived) {
            this.stroke = 'red'
          }
          if (properties.arrow) {
            this.arrowConfig.markerEnd = properties.arrow.markerEnd
          }
        }
        getArrowStyle () {
          const style = super.getArrowStyle();
          style.stroke = 'green';
          return style;
        }
      }
      
      class AnimationEdge extends BezierEdge {
  
      }

      class AnimationEdgeModel extends BezierEdgeModel {
        getEdgeAnimationStyle() {
          const style = super.getEdgeAnimationStyle();  
          style.stroke = 'blue'
          style.animationDuration = '30s'
          style.animationDirection = 'reverse'
          return style
        }  
      }
    </script>

    <!-- 实例化 LogicFlow -->
    <script>
      function InitLogicFlow() {
        const lf = new LogicFlow({
          container: document.querySelector('#app'),
          // hideAnchors: true,
          // width: 1200,
          height: 400,
          // adjustNodePosition: false,
          // isSilentMode: true,
          // overlapMode: 1,
          // hoverOutline: false,
          // nodeSelectedOutline: false,
          multipleSelectKey: 'shift',
          disabledTools: ['multipleSelect'],
          autoExpand: true,
          // metaKeyMultipleSelected: false,
          // adjustEdgeMiddle: true,
          // stopMoveGraph: true,
          adjustEdgeStartAndEnd: true,
          // adjustEdge: false,
          allowRotation: true,
          edgeTextEdit: true,
          keyboard: {
            enabled: true,
            // shortcuts: [
            //   {
            //     keys: ["backspace"],
            //     callback: () => {
            //       const r = window.confirm("确定要删除吗？");
            //       if (r) {
            //         const elements = lf.getSelectElements(true);
            //         lf.clearSelectElements();
            //         elements.edges.forEach((edge) => lf.deleteEdge(edge.id));
            //         elements.nodes.forEach((node) => lf.deleteNode(node.id));
            //         const graphData = lf.getGraphData()
            //         console.log(42, graphData, graphData.nodes.length)
            //       }
            //       // console.log(1)
            //     }
            //   }
            // ]

          },
          partial: true,
          background: {
            color: '#F0F0F0'
          },
          grid: true,
          edgeTextDraggable: true,
          edgeType: 'bezier',
          // 全局自定义id
          // edgeGenerator: (sourceNode, targetNode, currentEdge) => {
          //   // 起始节点类型 rect 时使用 自定义的边 custom-edge
          //   if (sourceNode.type === 'rect') return 'bezier'
          //   if (currentEdge) return currentEdge.type
          //   return 'polyline'
          // },
          idGenerator(type) {
            return type + '_' + Math.random()
          }
        });
        // 方便调试
        window.lf = lf;

        // 注册自定义节点
        lf.register({
          type: 'square',
          view: SquareView,
          model: SquareModel,
        });
        lf.register({
          type: 'star',
          view: PolygonNode,
          model: StarModel,
        });
        lf.register({
          type: 'user',
          view: UserNode,
          model: UserModel,
        });
        lf.register({
          type: 'combine',
          view: CombineNode,
          model: CombineModel,
        });
        lf.on('history:change', () => {
          const data = lf.getGraphData()
          console.log(data)
        })
        // 注册自定义边
        lf.register({
          type: 'connection',
          view: Connection,
          model: ConnectionModel,
        })

        lf.register({
          type: 'animationEdge',
          view: AnimationEdge,
          model: AnimationEdgeModel
        })
        lf.register({
          type: 'uml',
          view: UmlNode,
          model: UmlModel,
        })
        lf.setTheme(
          {
            baseNode: {
              fill: 'red',
              stroke: 'green'
            },
            nodeText: { overflowMode: 'ellipsis', lineHeight: 1.5 },
            edgeText: { overflowMode: 'ellipsis', lineHeight: 1.5 },
            polyline: {
              stroke: 'red',
            },
            rect: {
              width: 200,
              height: 40,
            },
            arrow: {
              offset: 4, // 箭头长度
              verticalLength: 2, // 箭头垂直于边的距离
            }
          }
        );
        // lf.setDefaultEdgeType('polyline');
      }
    </script>

    <!-- 元素相关方法 -->
    <script>
      const data = {
        nodes: [
          {
            id: "rect_0.04549269606577355",
            rotate: 1.1722738811284763,
            text: {x: 600, y: 200, value: 'xxxxx'},
            type: "rect",
            x: 600,
            y: 200
          }
        ]
      }
      function InitElementFunction() {
        window.showCanvas = function () {
          document.querySelector('#app').style.display = 'block'
          lf.render(data);
        }
        window.mouseDownRect = function mouseDownCircle() {
          lf.dnd.startDrag({
            type: 'rect',
            text: 'xxxxx'
          })
        }
        window.mouseDownCircle = function mouseDownRect() {
          lf.dnd.startDrag({
            type: 'circle',
            r: 25,
          })
        }
        window.getNodeEdges = function getNodeEdges() {
          const a = lf.getSelectElements().nodes[0].id;
          const edgeModels = lf.getNodeEdges(a)
          console.log(edgeModels);
        }
        window.mouseDownText = function mouseDownText() {
          lf.dnd.startDrag({
            type: 'text',
            text: '文本'
          })
        }
        window.focusOn = function focusOnStar() {
          lf.focusOn({
            id: '2222'
          })
        }
        window.undo = function undo() {
          lf.undo()
        }
        window.redo = function redo() {
          lf.redo()
        }
        window.clearData = function clearData() {
          lf.clearData()
        }
        window.changeEditConfig = function () {
          window.isSilentMode = !window.isSilentMode
          lf.updateEditConfig({
            isSilentMode: window.isSilentMode
          })
        }
        window.focusOut = function () {
          lf.graphModel.textEditElement.setElementState(1)
        }
        window.getData = function () {
          console.log(lf.getGraphData())
        }
        window.changeNodeType = function () {
          const { nodes } = lf.getSelectElements()
          nodes.forEach(({ id }) => {
            lf.changeNodeType(id, 'star')
          })
        }
        window.getRefreshData = function () {
          let data = lf.getGraphData();
          data = LogicFlowUtil.refreshGraphId(data);
          console.log(data);
          lf.render(data);
        }
        window.setProperties = function () {
          const { nodes, edges } = lf.getSelectElements()
          nodes.forEach(({ id }) => {
            lf.setProperties(id, {
              isActived: true
            })
          })
          edges.forEach(({ id }) => {
            lf.setProperties(id, {
              isActived: true
            })
          })
        }
        window.setProperties = function () {
          const { nodes, edges } = lf.getSelectElements()
          nodes.forEach(({ id }) => {
            lf.setProperties(id, {
              isActived: true
            })
          })
          edges.forEach(({ id }) => {
            lf.setProperties(id, {
              isActived: true
            })
          })
        }
        window.setArrow = function (arrowName) {

          const { edges } = lf.getSelectElements()
          edges.forEach(({ id, properties }) => {
            console.log(4444, properties);
            lf.setProperties(id, {
              arrowType: arrowName
            })
          })
        }
        window.setZoom = function () {
          // lf.graphModel.transformModel.SCALE_X  = 0.6
          // lf.graphModel.transformModel.SCALE_Y = 0.6
          lf.zoom(0.6, [400, 400])
        }
        window.selectElement = function () {
          lf.selectElementById('2222')
        }
        window.triggerLine = function () {
          // lf.startConnect()
        }
        window.translateCenter = function () {
          lf.translateCenter()
        }
        window.fitView = function () {
          lf.fitView(100, 100)
        }

        window.openEdgeAnimation = function () {
          const { edges } = lf.getGraphData();  
          edges.forEach(({id}) => {
            lf.openEdgeAnimation(id)
          }) 
        }

        window.closeEdgeAnimation = function() {
          const { edges } = lf.getGraphData();  
          edges.forEach(({id}) => {
            lf.closeEdgeAnimation(id)
          })
        }
        window.deleteNode = function () {
          const d = lf.deleteNode(1)
          console.log(d, lf.getGraphData().nodes.length)
        }
        window.changeEdgeId = function () {
          const { edges } = lf.getGraphData();
          edges.forEach(({ id }) => {
            lf.changeEdgeId(id, 'edge_' + id)
          })
        }
      }
    </script>

    <!-- LogicFlow 相关事件 -->
    <script>
      function InitLogicFlowEvent() {
        lf.on('history:change', ({ data: { undoAble, redoAble } }) => {
          document.getElementById('undo').disabled = !undoAble
          document.getElementById('redo').disabled = !redoAble
        });
        lf.on('text:update', (data) => {
          console.log('test:update', data)
        });
        lf.on('blank:mousemove', (data) => {
          console.log(data)
        })
        lf.on('node:click', ({ data }) => {
          // const model = lf.graphModel.getElement(data.id)
          // model.fill = 'red'
          // console.log(data.id)
          // console.log(lf.getGraphData())
          // lf.changeNodeId(data.id)
        })
        lf.on("blank:contextmenu", ({ e, position }) => {
          console.log("Ok");
          lf.addNode({
            type: "circle",
            x: position.canvasOverlayPosition.x,
            y: position.canvasOverlayPosition.y
          });
        });
        lf.on('node:delete',()=> {
          console.log('nodeup')
          const graphData = lf.getGraphData()
          console.log(graphData, graphData.nodes.length)
        })
        lf.on('node:contextmenu', () => {
          console.log(444)
        })
        lf.on('edge:adjust',({data})=> {
          console.log('edge:adjust', data)
        })
        lf.on('edge:exchange-node',({data})=> {
          console.log('edge:exchange-node', data)
        })
        lf.on('anchor:drop',(data) => {
          console.log('anchor:drop', data)
        })
        lf.on('anchor:dragend',(data) => {
          console.log('anchor:dragend', data)
        })
        lf.on('node:dnd-add',(data)=> {
          console.log('node:dnd-add', data)
        })
        lf.on('node:add', (data) => {
          console.log('node:add', data)
        })
        // lf.on('node:mouseenter', () => {
        //   console.log('node:mouseenter')
        // })
        // lf.on('node:mouseleave', () => {
        //   console.log('node:mouseleave')
        // })
        // lf.on('edge:mouseenter', () => {
        //   console.log('edge:mouseenter')
        // })
        // lf.on('edge:mouseleave', () => {
        //   console.log('edge:mouseleave')
        // })
        // lf.on('node:click', (eventData) => {
        //   console.log(eventData);
        //   console.log('node:click')
        // })
        // lf.on('edge:click', () => {
        //   console.log('edge:click')
        // })
        // lf.on('edge:dbclick', () => {
        //   console.log('edge:dbclick')
        // })
        // lf.on('edge:contextmenu', () => {
        //   console.log('edge:contextmenu')
        // })
        // lf.on('element:click', () => {
        //   console.log('element:click')
        // })
        // lf.on('blank:mousedown', () => {
        //   console.log('blank:mousedown')
        // })
        // lf.on('blank:mouseup', () => {
        //   console.log('blank:mouseup')
        // })
      }
    </script>
</body>

</html>